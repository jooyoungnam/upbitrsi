<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upbit RSI Dashboard</title>
  <style>
    body {
      background-color: black;
      color: white;
    }
    table, th, td {
      text-align: center;
      border-collapse: collapse;
    }
    @media only screen and (max-width: 600px) {
      table, th, td {
        font-size: 12px;
      }
    }

    thead th {
  position: sticky;
  top: 0;
  background-color: black;
}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <button onclick="exportToExcel()">ì—‘ì…€ë¡œ ì €ì¥í•˜ê¸°</button>
  
  <script>
    let countdown = 60;
    let rsiData = {};
    let isWaiting = false;
    let selectedInterval = "240";
    let loadingDots = 0;
    let loadingInterval;

    function startLoadingMessage() {
  const waitingMessageElement = document.getElementById("waitingMessage");
  waitingMessageElement.style.color = 'red';  // ê¸€ììƒ‰ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½
  waitingMessageElement.innerText = `í˜„ì¬ ${selectedInterval} ê¸°ì¤€ìœ¼ë¡œ RSIë¥¼ ê°±ì‹  ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”`;
  loadingInterval = setInterval(() => {
    loadingDots = (loadingDots + 1) % 4;
    const dots = ".".repeat(loadingDots);
    waitingMessageElement.innerText = `í˜„ì¬ ${selectedInterval} ê¸°ì¤€ìœ¼ë¡œ RSIë¥¼ ê°±ì‹  ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”${dots}`;
  }, 500); // 0.5ì´ˆë§ˆë‹¤ ì‹¤í–‰
}


    function exportToExcel() {
        const table = document.getElementById("rsiTableBody").parentNode; 
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        
        // ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        
        const currentDate = new Date();
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // 1ì›”ì€ 0ì„ ë°˜í™˜í•˜ë¯€ë¡œ 1ì„ ë”í•©ë‹ˆë‹¤.
        const day = String(currentDate.getDate()).padStart(2, '0');
        const hours = String(currentDate.getHours()).padStart(2, '0');
        const minutes = String(currentDate.getMinutes()).padStart(2, '0');
        
        const formattedDate = `${year}-${month}-${day}-${hours}${minutes}`;
        const fileName = `${formattedDate}.xlsx`;

        XLSX.writeFile(wb, fileName);
    }



    function stopLoadingMessage() {
      clearInterval(loadingInterval);
      document.getElementById("waitingMessage").innerText = '';
    }

    async function fetchRSI() {
      isWaiting = true;
      countdown = 60;
      document.getElementById("countdown").innerText = countdown;

      startLoadingMessage();

      const interval = selectedInterval;
      let url;
      if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
        url = `http://localhost:3000/rsi?interval=${interval}`;
      } else {
        url = `https://port-0-upbitrsi-2rrqq2blmm4tos2.sel5.cloudtype.app/rsi?interval=${interval}`;
      }
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        rsiData = data.rsiData;
        updateTable();
        sortData();
        updateCurrentTime();
      } catch (e) {
        document.getElementById("waitingMessage").innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      }

      stopLoadingMessage();
      isWaiting = false;
      document.getElementById("waitingMessage").innerText = '';
    }

   function updateCountdown() {
      if (!isWaiting) {
        countdown--;
        document.getElementById("countdown").innerText = countdown;
        if (countdown <= 0) {
          fetchRSI();
        }
      }
    }

function updateTable() {
    const tableBody = document.getElementById("rsiTableBody");
    tableBody.innerHTML = "";  // í…Œì´ë¸” ë‚´ìš© ì´ˆê¸°í™”
    let rank = 1;

    for (const market in rsiData) {
        const rsiValue = rsiData[market].rsi;
        const rsiColor = getRSIColor(rsiValue);

        // í˜„ì¬ê°€ ì²˜ë¦¬
        const currentPriceValue = Number(String(rsiData[market].currentPrice).replace(' KRW', '').replace(/,/g, ''));
        const decimalPlaces = (currentPriceValue % 1) ? currentPriceValue.toString().split('.')[1].length : 0; 
        const currentPrice = decimalPlaces === 0 ? currentPriceValue.toLocaleString() : currentPriceValue.toFixed(decimalPlaces);

        // ì˜ˆì¸¡ê°€ ì²˜ë¦¬
        let scikitPredictedPriceValue = parseFloat(String(rsiData[market].scikitPredictedPrice).replace(' KRW', '').replace(/,/g, ''));
        let formattedScikitPredictedPrice = decimalPlaces === 0 ? scikitPredictedPriceValue.toLocaleString() : scikitPredictedPriceValue.toFixed(decimalPlaces);

        // í˜„ì¬ê°€ì™€ ì˜ˆì¸¡ê°€ ë¹„êµ
        let arrow;
        if (scikitPredictedPriceValue > currentPriceValue) {
            arrow = `<span style="color:red;">â¬†ï¸</span>`;
        } else if (scikitPredictedPriceValue < currentPriceValue) {
            arrow = `<span style="color:blue;">ğŸ”»</span>`;
        } else {
            arrow = '';
        }

        const priceDifferenceValue = scikitPredictedPriceValue - currentPriceValue;
        const formattedPriceDifference = decimalPlaces === 0 ? priceDifferenceValue.toLocaleString() : priceDifferenceValue.toFixed(decimalPlaces);

        // ì¼ì£¼ì¼ ê°€ê²© ë°ì´í„° ì²˜ë¦¬
        const sevenDayPrices = rsiData[market].sevenDayPrices || [];
        let priceRows = '';
        for (let i = 0; i < sevenDayPrices.length; i++) {
            priceRows += `<td>${Number(String(sevenDayPrices[i]).replace(/,/g, '')).toLocaleString()}</td>`;
        }

        const row = `<tr style="color:${rsiColor}">
          <td>${rank}</td>
          <td>${rsiData[market].korean_name}</td>
          <td>${market}</td>
          <td>${rsiValue.toFixed(2)}</td>
          <td>${arrow}</td>
          <td>${formattedPriceDifference}</td>
          <td>${formattedScikitPredictedPrice}</td>
          <td>${currentPrice}</td>
          ${priceRows}
        </tr>`;
        tableBody.innerHTML += row;
        rank++;
    }
}





    function getRSIColor(rsi) {
      if (rsi >= 70) return '#ff0800';
      if (rsi >= 60) return 'yellow';
      if (rsi >= 50) return '#FF8C00';
      if (rsi >= 40) return '#32CD32';
      if (rsi >= 30) return '#87CEEB';
      return '#1E90FF';
    }

    function updateCurrentTime() {
      const now = new Date();
      const formattedTime = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
      document.getElementById("lastUpdated").innerText = formattedTime;
    }

    function sortData() {
      const sortOption = document.getElementById("sortOption").value;
      if (sortOption === 'asc') {
        rsiData = Object.fromEntries(
          Object.entries(rsiData).sort(([, a], [, b]) => a.rsi - b.rsi)
        );
      } else if (sortOption === 'desc') {
        rsiData = Object.fromEntries(
          Object.entries(rsiData).sort(([, a], [, b]) => b.rsi - a.rsi)
        );
      }
      updateTable();
    }

    window.onload = () => {
      fetchRSI().then(() => sortData());
      setInterval(updateCountdown, 1000);

      document.getElementById("intervalSelect").addEventListener("change", (event) => {
  const newInterval = event.target.value;
  selectedInterval = newInterval;  // ì´ ë¶€ë¶„ì€ í•­ìƒ ì‹¤í–‰ë©ë‹ˆë‹¤.
  fetchRSI().then(() => sortData());  // ì´ ë¶€ë¶„ë„ í•­ìƒ ì‹¤í–‰ë©ë‹ˆë‹¤.
});



      document.getElementById("sortOption").addEventListener("change", () => {
        sortData();
      });
    };
  </script>
</head>
<body>
  <p id="waitingMessage"></p>
  <p>í˜„ì¬ ì‹œê°„: <span id="lastUpdated"></span></p>
  <p>Next update in: <span id="countdown">60</span> seconds.</p>
  <h1>Upbit RSI Dashboard</h1>

  <label for="sortOption">ì •ë ¬:</label>
  <select id="sortOption">
    <option value="asc">RSIì˜¤ë¦„ì°¨ìˆœ</option>
    <option value="desc" selected>RSIë‚´ë¦¼ì°¨ìˆœ</option>
  </select>

  <label for="intervalSelect">ì‹œê°„:</label>
  <select id="intervalSelect">
    <option value="1">1ë¶„</option>
    <option value="3">3ë¶„</option>
    <option value="5">5ë¶„</option>
    <option value="10">10ë¶„</option>
    <option value="15">15ë¶„</option>
    <option value="30">30ë¶„</option>
    <option value="60">60ë¶„</option>
    <option value="240" selected>240ë¶„</option>
    <option value="day">ì¼</option>
    <option value="week">ì£¼</option>
    <option value="month">ì›”</option>
  </select>

  <table border="1">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Korean Name</th>
        <th>Market</th>
        <th>RSI</th>
        <th>ì—…ë‹¤ìš´</th>
        <th>ì°¨ì•¡</th>
        <th>ë‚´ì¼ì˜ˆì¸¡ê°€(Scikit)</th>
        <th>í˜„ì¬ê°€</th>
        <th>1ì¼ì „</th> <!-- ì¶”ê°€ -->
        <th>2ì¼ì „</th> <!-- ì¶”ê°€ -->
        <th>3ì¼ì „</th> <!-- ì¶”ê°€ -->
        <th>4ì¼ì „</th> <!-- ì¶”ê°€ -->
        <th>5ì¼ì „</th> <!-- ì¶”ê°€ -->
        <th>6ì¼ì „</th> <!-- ì¶”ê°€ -->
        <th>7ì¼ì „</th> <!-- ì¶”ê°€ -->
      </tr>
    </thead>
    <tbody id="rsiTableBody">
      <!-- RSI ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
    </tbody>
  </table>
</body>
</html>
