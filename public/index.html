<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RSI Dashboard</title>
  <script>
    let isLoading = false;
    let countdown = 60;
    let countdownInterval;
    const displayedRSI = new Set();

    function getRSIColor(rsi) {
      if (rsi >= 70) return 'darkred';
      if (rsi >= 60) return 'red';
      if (rsi >= 50) return 'indianred';
      if (rsi >= 40) return 'green';
      if (rsi >= 30) return 'lightblue';
      return 'blue';
    }

    async function fetchAndDisplayRSI() {
      isLoading = true;

      const response = await fetch(`http://localhost:3000/rsi`);
      const { rsiData } = await response.json();

      let content = '';
      for (const [market, data] of Object.entries(rsiData)) {
        const { rsi, korean_name } = data;

        if (!displayedRSI.has(market)) {
          const color = getRSIColor(rsi);
          content += `<div style="color: ${color}">${korean_name} (${market}) - RSI: ${rsi.toFixed(2)}</div>`;
          displayedRSI.add(market);
        }
      }

      const rsiDisplay = document.getElementById('rsiDisplay');
      rsiDisplay.innerHTML = content + rsiDisplay.innerHTML;

      isLoading = false;
    }

    function displayCountdown() {
      // 카운트 다운을 표시하고 1초씩 감소합니다.
      const countdownDisplay = document.getElementById('countdownDisplay');
      countdownDisplay.innerText = `${countdown}초`;
      countdown--;

      // 카운트 다운이 0 이상인 경우에 계속 감소하도록 합니다.
      if (countdown >= 0) {
        countdownInterval = setTimeout(displayCountdown, 1000); // 1초마다 업데이트
      } else {
        // 카운트 다운이 완료되면 새로고침
        fetchAndDisplayRSI();
        countdown = 60; // 카운트 다운 초기화
        countdownDisplay.innerText = `${countdown}초`; // 초기 카운트 다운 표시
      }
    }

    window.onload = function() {
      fetchAndDisplayRSI();
      countdownInterval = setTimeout(displayCountdown, 1000);
      setInterval(() => {
        if (!isLoading) {
          fetchAndDisplayRSI();
        }
      }, 60000);
    };
  </script>
</head>
<body style="background-color: black;">
  <h1 style="color: white;">Upbit KRW Coins RSI</h1>
  <div id="rsiDisplay"></div>
  <div id="countdownDisplay" style="color: white;">60초</div>
</body>
</html>